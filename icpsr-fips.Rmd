---
title: "FIPS / ICPSR"
output:
  html_document: default
---

## Setup

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
  
library(tidyverse)

```

## ICPSR Table

```{r}
## ICPSR Excel table from https://usa.ipums.org/usa/volii/ICPSR.shtml
icpsr <- read_csv("data/icpsrcnt.csv") %>% 
  janitor::clean_names() %>% 
  rename(icp_county = county, 
         icp_state = state, 
         icp_statefips = statefips, 
         icp_statecode = stateicp, 
         icp_county_cod = county_cod) %>% 
  select(icp_state, icp_county, everything())

## Table
icpsr
```


## FIPS table  

This is from my own repo. This may not be up to date! Can get more current list from the Census

```{r}
fips <- read_csv("https://raw.githubusercontent.com/kjhealy/fips-codes/master/county_fips_master.csv")


## Words that end the names of "counties"
end_words <- c("Borough", "County", "Area", "Municipality", 
               "Columbia", "Parish", "city", "City")

## A regular expression to match them
end_words_re <- paste0(end_words, collapse = "|")


## Make a column with "county" names but with end words deleted
## Doing this to facilitate matching with icpsr table
fips <- fips %>% 
  mutate(county_clipped = str_remove(county_name, end_words_re), 
         county_clipped = str_squish(county_clipped)) %>% 
  select(fips, county_name, state_abbr, state, county_clipped, everything())

## Table
fips
```

## Joining the tables

### 1. Left-join `icpsr` table to `fips` table

This will preserve all rows in `icpsr` but any rows in fips not matched in icpsr won't be merged.

```{r}
## Result: 3,265 x 19
icpsr_ljoin_fips <- icpsr %>% 
  left_join(fips, by = c("icp_state" = "state_name", 
                         "icp_county" = "county_clipped"), 
            keep = TRUE)

write_csv(icpsr_ljoin_fips, file = "data/icpsr_ljoin_fips.csv")


icpsr_ljoin_fips

```

What's missing in this table after the merge? If FIPS is missing, the county didn't exist in the original `fips` table.

```{r}
## 279 rows missing
icpsr_nofips <- icpsr_ljoin_fips %>% 
  filter(is.na(fips)) 

icpsr_nofips

write_csv(file = "data/icpsr_nofips.csv", icpsr_nofips)
```

### 2. Left join `fips` to `icpsr`

With `fips` on the left side of the join, this will preserve all rows in `fips`, but any rows in `icpsr` not matched in fips won't be merged.

```{r}
# Result: 3,146 Ã— 19
fips_ljoin_icpsr <- fips %>% 
  left_join(icpsr, by = c("state_name" = "icp_state", 
                           "county_clipped" = "icp_county"), 
             keep = TRUE)

write_csv(fips_ljoin_icpsr, file = "data/fips_ljoin_icpsr.csv")

fips_ljoin_icpsr
```

What's missing after merging this way? If the `icp_county_cod` is missing, the county didn't exist in the original `icpsr` table. 

```{r}
### 160 rows missing
missing_icpcod <- fips_ljoin_icpsr %>% 
  filter(is.na(icp_county_cod)) 

missing_icpcod

write_csv(missing_icpcod, file = "data/missing_icp_cod.csv")

```


### 3. Full join: merges tables, preserves all rows in both tables

```{r}
## Result: 3,425 x 19
county_fulljoin <- icpsr %>% 
  full_join(fips, by = c("icp_state" = "state_name", 
                                "icp_county" = "county_clipped"), 
            keep = TRUE)

write_csv(county_fulljoin, file = "data/county_fulljoin.csv")

county_fulljoin

```

The missings from both the original tables are in this table.



  
